name: Android Release

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: gradle

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Validate signing secrets
        env:
          KEY_STORE: ${{ secrets.KEY_STORE }}
          KEY_PROPERTIES: ${{ secrets.KEY_PROPERTIES }}
        run: |
          set -euo pipefail
          if [ -z "${KEY_STORE}" ] || [ -z "${KEY_PROPERTIES}" ]; then
            echo "Missing GitHub Secrets: KEY_STORE and/or KEY_PROPERTIES" >&2
            exit 1
          fi

      - name: Restore keystore & key.properties
        env:
          KEY_STORE: ${{ secrets.KEY_STORE }}
          KEY_PROPERTIES: ${{ secrets.KEY_PROPERTIES }}
        run: |
          set -euo pipefail

          mkdir -p android/app

          echo "$KEY_STORE" | base64 --decode > android/app/key.jks

          # Write properties (may contain newlines)
          printf '%s' "$KEY_PROPERTIES" > android/app/key.properties

          # Normalize storeFile so Gradle can find the keystore
          python3 - <<'PY'
          from pathlib import Path

          path = Path('android/app/key.properties')
          text = path.read_text(encoding='utf-8')

          lines = []
          has_store = False
          for line in text.splitlines():
            if line.strip().startswith('storeFile='):
              lines.append('storeFile=key.jks')
              has_store = True
            else:
              lines.append(line)

          if not has_store:
            lines.append('storeFile=key.jks')

          path.write_text('\n'.join(lines).rstrip() + '\n', encoding='utf-8')
          PY

      - name: Create .env file
        env:
          ENV_FILE: ${{ secrets.ENV_FILE }}
        run: |
          printf '%s' "$ENV_FILE" > .env

      - name: Install dependencies
        run: flutter pub get

      - name: Build Android (APK + AAB)
        run: |
          set -euo pipefail
          # 1. 构建 AAB (用于 Google Play)
          flutter build appbundle --release --dart-define-from-file=.env
          
          # 2. 构建通用 Fat APK (包含所有架构)
          flutter build apk --release --dart-define-from-file=.env
          
          # 3. 构建分架构 APK (arm64-v8a, armeabi-v7a, x86_64)
          flutter build apk --release --split-per-abi --dart-define-from-file=.env

      - name: Rename artifacts for release
        run: |
          set -euo pipefail
          # 获取版本号 (从 pubspec.yaml)
          VERSION=$(grep 'version: ' pubspec.yaml | sed 's/version: //')
          APP_NAME="moecalendar"
          
          echo "Renaming artifacts for version $VERSION..."
          
          # 重命名 AAB
          if [ -f build/app/outputs/bundle/release/app-release.aab ]; then
            mv build/app/outputs/bundle/release/app-release.aab build/app/outputs/bundle/release/${APP_NAME}-v${VERSION}.aab
          fi
          
          # 重命名 APKs
          cd build/app/outputs/flutter-apk/
          
          # 通用包
          if [ -f app-release.apk ]; then
            mv app-release.apk ${APP_NAME}-v${VERSION}-universal.apk
          fi
          
          # 分架构包
          if [ -f app-arm64-v8a-release.apk ]; then
            mv app-arm64-v8a-release.apk ${APP_NAME}-v${VERSION}-arm64-v8a.apk
          fi
          if [ -f app-armeabi-v7a-release.apk ]; then
            mv app-armeabi-v7a-release.apk ${APP_NAME}-v${VERSION}-armeabi-v7a.apk
          fi
          if [ -f app-x86_64-release.apk ]; then
            mv app-x86_64-release.apk ${APP_NAME}-v${VERSION}-x86_64.apk
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-release
          if-no-files-found: error
          path: |
            build/app/outputs/flutter-apk/*.apk
            build/app/outputs/bundle/release/*.aab

      - name: Create GitHub Release (tag build)
        env:
          RELEASE_TOKEN: ${{ secrets.RELEASE_TOKEN }}
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.RELEASE_TOKEN }}
          draft: true
          generate_release_notes: true
          files: |
            build/app/outputs/flutter-apk/*.apk
            build/app/outputs/bundle/release/*.aab
